import { memo, useCallback, useEffect, useRef, useState } from 'react';
import type { Vulnerability, VulnerabilitySummary } from '../types/models';
import { api } from '../api/client';
import type { ScanStatusResponse } from '../api/client';

const SEVERITY_COLORS: Record<string, { bg: string; text: string; border: string }> = {
  critical: { bg: 'bg-red-100 dark:bg-red-900/40', text: 'text-red-800 dark:text-red-300', border: 'border-red-300 dark:border-red-700' },
  high: { bg: 'bg-orange-100 dark:bg-orange-900/40', text: 'text-orange-800 dark:text-orange-300', border: 'border-orange-300 dark:border-orange-700' },
  medium: { bg: 'bg-yellow-100 dark:bg-yellow-900/40', text: 'text-yellow-800 dark:text-yellow-300', border: 'border-yellow-300 dark:border-yellow-700' },
  low: { bg: 'bg-blue-100 dark:bg-blue-900/40', text: 'text-blue-800 dark:text-blue-300', border: 'border-blue-300 dark:border-blue-700' },
};

const STATUS_LABELS: Record<string, string> = {
  open: 'Open',
  mitigated: 'Mitigated',
  accepted: 'Accepted',
  false_positive: 'False Positive',
};

interface VulnerabilityPanelProps {
  projectId: string;
  zones: Array<{ id: string; name: string; assets: Array<{ id: string; name: string; vendor?: string }> }>;
  onClose?: () => void;
}

const SeverityBadge = memo(({ severity }: { severity: string }) => {
  const colors = SEVERITY_COLORS[severity] || SEVERITY_COLORS.low;
  return (
    <span className={`inline-block px-2 py-0.5 rounded text-xs font-semibold ${colors.bg} ${colors.text}`}>
      {severity.charAt(0).toUpperCase() + severity.slice(1)}
    </span>
  );
});

SeverityBadge.displayName = 'SeverityBadge';

const VulnerabilityPanel = memo(({ projectId, zones, onClose }: VulnerabilityPanelProps) => {
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [summary, setSummary] = useState<VulnerabilitySummary | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [filterSeverity, setFilterSeverity] = useState<string>('');
  const [filterStatus, setFilterStatus] = useState<string>('');
  const [showAddForm, setShowAddForm] = useState(false);
  const [updatingId, setUpdatingId] = useState<string | null>(null);

  // Add form state
  const [formZoneId, setFormZoneId] = useState('');
  const [formAssetId, setFormAssetId] = useState('');
  const [formCveId, setFormCveId] = useState('');
  const [formTitle, setFormTitle] = useState('');
  const [formDescription, setFormDescription] = useState('');
  const [formSeverity, setFormSeverity] = useState('medium');
  const [formCvss, setFormCvss] = useState('');
  const [formSubmitting, setFormSubmitting] = useState(false);
  const [autoFillStatus, setAutoFillStatus] = useState<string | null>(null);

  // Scan state
  const [scanningAssetId, setScanningAssetId] = useState<string | null>(null);
  const [scanResult, setScanResult] = useState<string | null>(null);
  const [batchScan, setBatchScan] = useState<ScanStatusResponse | null>(null);
  const batchPollRef = useRef<ReturnType<typeof setInterval> | null>(null);

  const loadData = useCallback(async () => {
    try {
      setError(null);
      const [vulns, sum] = await Promise.all([
        api.listVulnerabilities(projectId, {
          severity: filterSeverity || undefined,
          status: filterStatus || undefined,
        }),
        api.getVulnerabilitySummary(projectId),
      ]);
      setVulnerabilities(vulns);
      setSummary(sum);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load vulnerabilities');
    } finally {
      setLoading(false);
    }
  }, [projectId, filterSeverity, filterStatus]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  // CVE auto-fill from NVD
  useEffect(() => {
    if (!formCveId || !/^CVE-\d{4}-\d{4,}$/.test(formCveId)) {
      setAutoFillStatus(null);
      return;
    }
    const timer = setTimeout(async () => {
      try {
        setAutoFillStatus('looking up...');
        const result = await api.lookupCve(projectId, formCveId);
        setFormTitle(result.title);
        if (result.description) setFormDescription(result.description);
        setFormSeverity(result.severity === 'unknown' ? 'medium' : result.severity);
        if (result.cvss_score != null) setFormCvss(String(result.cvss_score));
        setAutoFillStatus('Auto-filled from NVD');
      } catch {
        setAutoFillStatus(null);
      }
    }, 500);
    return () => clearTimeout(timer);
  }, [formCveId, projectId]);

  // Cleanup batch poll on unmount
  useEffect(() => {
    return () => {
      if (batchPollRef.current) clearInterval(batchPollRef.current);
    };
  }, []);

  const handleScanAsset = useCallback(async (zoneId: string, assetId: string) => {
    setScanningAssetId(assetId);
    setScanResult(null);
    try {
      const result = await api.scanAssetCves(projectId, zoneId, assetId);
      setScanResult(`Found ${result.cves_found} CVEs, ${result.cves_created} new`);
      await loadData();
    } catch (err) {
      setScanResult(err instanceof Error ? err.message : 'Scan failed');
    } finally {
      setScanningAssetId(null);
    }
  }, [projectId, loadData]);

  const handleBatchScan = useCallback(async () => {
    try {
      const result = await api.scanAllCves(projectId);
      setBatchScan(result);

      // Poll for progress
      batchPollRef.current = setInterval(async () => {
        try {
          const status = await api.getScanStatus(projectId, result.job_id);
          setBatchScan(status);
          if (status.status === 'completed') {
            if (batchPollRef.current) clearInterval(batchPollRef.current);
            batchPollRef.current = null;
            await loadData();
          }
        } catch {
          if (batchPollRef.current) clearInterval(batchPollRef.current);
          batchPollRef.current = null;
        }
      }, 2000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Batch scan failed');
    }
  }, [projectId, loadData]);

  const handleStatusChange = useCallback(async (vulnId: string, newStatus: string) => {
    setUpdatingId(vulnId);
    try {
      await api.updateVulnerability(projectId, vulnId, { status: newStatus });
      await loadData();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to update status');
    } finally {
      setUpdatingId(null);
    }
  }, [projectId, loadData]);

  const handleDelete = useCallback(async (vulnId: string) => {
    if (!globalThis.confirm('Delete this vulnerability? This cannot be undone.')) return;
    try {
      await api.deleteVulnerability(projectId, vulnId);
      await loadData();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to delete vulnerability');
    }
  }, [projectId, loadData]);

  const handleAddSubmit = useCallback(async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formZoneId || !formAssetId || !formCveId || !formTitle) return;

    setFormSubmitting(true);
    try {
      await api.createVulnerability(projectId, formZoneId, formAssetId, {
        cve_id: formCveId,
        title: formTitle,
        description: formDescription || undefined,
        severity: formSeverity,
        cvss_score: formCvss ? parseFloat(formCvss) : undefined,
      });
      setShowAddForm(false);
      setFormCveId('');
      setFormTitle('');
      setFormDescription('');
      setFormSeverity('medium');
      setFormCvss('');
      setFormZoneId('');
      setFormAssetId('');
      await loadData();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to add vulnerability');
    } finally {
      setFormSubmitting(false);
    }
  }, [projectId, formZoneId, formAssetId, formCveId, formTitle, formDescription, formSeverity, formCvss, loadData]);

  const selectedZone = zones.find(z => z.id === formZoneId);

  return (
    <div className="h-full flex flex-col bg-white dark:bg-gray-800">
      {/* Header */}
      <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <h2 className="text-lg font-semibold text-gray-800 dark:text-gray-100">Vulnerabilities</h2>
        <div className="flex items-center gap-2">
          <button
            onClick={handleBatchScan}
            disabled={!!batchScan && batchScan.status === 'running'}
            className="px-3 py-1.5 text-sm bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 transition-colors"
            title="Scan all assets with vendor info for known CVEs"
          >
            {batchScan?.status === 'running' ? 'Scanning...' : 'Scan All Assets'}
          </button>
          <button
            onClick={() => setShowAddForm(!showAddForm)}
            className="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
          >
            + Add Vulnerability
          </button>
          {onClose && (
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
              aria-label="Close vulnerability panel"
            >
              &#10005;
            </button>
          )}
        </div>
      </div>

      {/* Summary Stats */}
      {summary && (
        <div className="p-4 border-b border-gray-200 dark:border-gray-700">
          <div className="grid grid-cols-5 gap-2 text-center">
            <div className="bg-gray-50 dark:bg-gray-700 rounded p-2">
              <div className="text-lg font-bold text-gray-800 dark:text-gray-100">{summary.total}</div>
              <div className="text-xs text-gray-500 dark:text-gray-400">Total</div>
            </div>
            <div className="bg-red-50 dark:bg-red-900/30 rounded p-2">
              <div className="text-lg font-bold text-red-700 dark:text-red-400">{summary.by_severity.critical || 0}</div>
              <div className="text-xs text-red-600 dark:text-red-400">Critical</div>
            </div>
            <div className="bg-orange-50 dark:bg-orange-900/30 rounded p-2">
              <div className="text-lg font-bold text-orange-700 dark:text-orange-400">{summary.by_severity.high || 0}</div>
              <div className="text-xs text-orange-600 dark:text-orange-400">High</div>
            </div>
            <div className="bg-yellow-50 dark:bg-yellow-900/30 rounded p-2">
              <div className="text-lg font-bold text-yellow-700 dark:text-yellow-400">{summary.by_severity.medium || 0}</div>
              <div className="text-xs text-yellow-600 dark:text-yellow-400">Medium</div>
            </div>
            <div className="bg-blue-50 dark:bg-blue-900/30 rounded p-2">
              <div className="text-lg font-bold text-blue-700 dark:text-blue-400">{summary.by_severity.low || 0}</div>
              <div className="text-xs text-blue-600 dark:text-blue-400">Low</div>
            </div>
          </div>
        </div>
      )}

      {/* Batch Scan Progress */}
      {batchScan && (
        <div className="p-3 border-b border-gray-200 dark:border-gray-700">
          <div className="flex items-center justify-between text-sm mb-1">
            <span className="text-gray-600 dark:text-gray-400">
              CVE Scan: {batchScan.assets_scanned}/{batchScan.total_assets} assets
            </span>
            <span className="text-gray-500 dark:text-gray-400">
              {batchScan.total_cves_found} found, {batchScan.total_cves_created} new
            </span>
          </div>
          <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div
              className="bg-green-600 h-2 rounded-full transition-all"
              style={{ width: `${batchScan.total_assets ? (batchScan.assets_scanned / batchScan.total_assets) * 100 : 0}%` }}
            />
          </div>
          {batchScan.status === 'completed' && (
            <button
              onClick={() => setBatchScan(null)}
              className="text-xs text-gray-400 hover:text-gray-600 mt-1"
            >
              Dismiss
            </button>
          )}
        </div>
      )}

      {/* Filters */}
      <div className="p-4 border-b border-gray-200 dark:border-gray-700 flex gap-3">
        <select
          value={filterSeverity}
          onChange={(e) => setFilterSeverity(e.target.value)}
          className="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
          aria-label="Filter by severity"
        >
          <option value="">All Severities</option>
          <option value="critical">Critical</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
        <select
          value={filterStatus}
          onChange={(e) => setFilterStatus(e.target.value)}
          className="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
          aria-label="Filter by status"
        >
          <option value="">All Statuses</option>
          <option value="open">Open</option>
          <option value="mitigated">Mitigated</option>
          <option value="accepted">Accepted</option>
          <option value="false_positive">False Positive</option>
        </select>
      </div>

      {/* Add Form */}
      {showAddForm && (
        <div className="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
          <h3 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Add Vulnerability</h3>
          <form onSubmit={handleAddSubmit} className="space-y-3">
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-gray-500 dark:text-gray-400 block mb-1">Zone</label>
                <select
                  value={formZoneId}
                  onChange={(e) => { setFormZoneId(e.target.value); setFormAssetId(''); }}
                  className="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1.5 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                  required
                >
                  <option value="">Select zone...</option>
                  {zones.map(z => (
                    <option key={z.id} value={z.id}>{z.name}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="text-xs text-gray-500 dark:text-gray-400 block mb-1">Asset</label>
                <select
                  value={formAssetId}
                  onChange={(e) => setFormAssetId(e.target.value)}
                  className="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1.5 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                  required
                  disabled={!formZoneId}
                >
                  <option value="">Select asset...</option>
                  {selectedZone?.assets.map(a => (
                    <option key={a.id} value={a.id}>{a.name}</option>
                  ))}
                </select>
                {formZoneId && formAssetId && selectedZone?.assets.find(a => a.id === formAssetId)?.vendor && (
                  <button
                    type="button"
                    onClick={() => handleScanAsset(formZoneId, formAssetId)}
                    disabled={scanningAssetId === formAssetId}
                    className="mt-1 text-xs text-green-600 dark:text-green-400 hover:underline disabled:opacity-50"
                  >
                    {scanningAssetId === formAssetId ? 'Scanning...' : 'Scan for CVEs'}
                  </button>
                )}
                {scanResult && (
                  <span className="text-xs text-gray-500 dark:text-gray-400 block mt-0.5">{scanResult}</span>
                )}
              </div>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-gray-500 dark:text-gray-400 block mb-1">CVE ID</label>
                <input
                  type="text"
                  value={formCveId}
                  onChange={(e) => setFormCveId(e.target.value)}
                  placeholder="CVE-2024-12345"
                  pattern="CVE-\d{4}-\d{4,}"
                  className="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1.5 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                  required
                />
                {autoFillStatus && (
                  <span className="text-xs text-green-600 dark:text-green-400 mt-0.5 block">{autoFillStatus}</span>
                )}
              </div>
              <div>
                <label className="text-xs text-gray-500 dark:text-gray-400 block mb-1">Severity</label>
                <select
                  value={formSeverity}
                  onChange={(e) => setFormSeverity(e.target.value)}
                  className="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1.5 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                >
                  <option value="critical">Critical</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
            </div>
            <div>
              <label className="text-xs text-gray-500 dark:text-gray-400 block mb-1">Title</label>
              <input
                type="text"
                value={formTitle}
                onChange={(e) => setFormTitle(e.target.value)}
                placeholder="Vulnerability title"
                className="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1.5 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                required
              />
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-gray-500 dark:text-gray-400 block mb-1">CVSS Score (optional)</label>
                <input
                  type="number"
                  value={formCvss}
                  onChange={(e) => setFormCvss(e.target.value)}
                  placeholder="0.0 - 10.0"
                  min="0"
                  max="10"
                  step="0.1"
                  className="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1.5 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                />
              </div>
            </div>
            <div>
              <label className="text-xs text-gray-500 dark:text-gray-400 block mb-1">Description (optional)</label>
              <textarea
                value={formDescription}
                onChange={(e) => setFormDescription(e.target.value)}
                rows={2}
                className="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1.5 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
              />
            </div>
            <div className="flex gap-2">
              <button
                type="submit"
                disabled={formSubmitting}
                className="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 transition-colors"
              >
                {formSubmitting ? 'Adding...' : 'Add Vulnerability'}
              </button>
              <button
                type="button"
                onClick={() => setShowAddForm(false)}
                className="px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      )}

      {/* Error */}
      {error && (
        <div className="p-3 mx-4 mt-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded text-sm text-red-700 dark:text-red-300">
          {error}
          <button onClick={() => setError(null)} className="ml-2 text-red-500 hover:text-red-700">&#10005;</button>
        </div>
      )}

      {/* Vulnerability List */}
      <div className="flex-1 overflow-y-auto p-4">
        {loading ? (
          <div className="text-center text-gray-500 dark:text-gray-400 py-8">Loading vulnerabilities...</div>
        ) : vulnerabilities.length === 0 ? (
          <div className="text-center text-gray-500 dark:text-gray-400 py-8">
            <p className="text-sm">No vulnerabilities found</p>
            <p className="text-xs mt-1">Click "Add Vulnerability" to track CVEs for project assets</p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-gray-200 dark:border-gray-700">
                  <th className="text-left py-2 px-2 text-xs font-semibold text-gray-500 dark:text-gray-400">CVE ID</th>
                  <th className="text-left py-2 px-2 text-xs font-semibold text-gray-500 dark:text-gray-400">Asset</th>
                  <th className="text-left py-2 px-2 text-xs font-semibold text-gray-500 dark:text-gray-400">Severity</th>
                  <th className="text-left py-2 px-2 text-xs font-semibold text-gray-500 dark:text-gray-400">CVSS</th>
                  <th className="text-left py-2 px-2 text-xs font-semibold text-gray-500 dark:text-gray-400">Status</th>
                  <th className="text-left py-2 px-2 text-xs font-semibold text-gray-500 dark:text-gray-400">Actions</th>
                </tr>
              </thead>
              <tbody>
                {vulnerabilities.map((vuln) => (
                  <tr
                    key={vuln.id}
                    className="border-b border-gray-100 dark:border-gray-700/50 hover:bg-gray-50 dark:hover:bg-gray-700/50"
                  >
                    <td className="py-2 px-2">
                      <div className="font-mono text-xs text-gray-800 dark:text-gray-200">{vuln.cve_id}</div>
                      <div className="text-xs text-gray-500 dark:text-gray-400 truncate max-w-[200px]" title={vuln.title}>
                        {vuln.title}
                      </div>
                    </td>
                    <td className="py-2 px-2">
                      <div className="text-xs text-gray-800 dark:text-gray-200">{vuln.asset_name || 'Unknown'}</div>
                      {vuln.zone_name && (
                        <div className="text-xs text-gray-400 dark:text-gray-500">{vuln.zone_name}</div>
                      )}
                    </td>
                    <td className="py-2 px-2">
                      <SeverityBadge severity={vuln.severity} />
                    </td>
                    <td className="py-2 px-2 text-xs text-gray-700 dark:text-gray-300">
                      {vuln.cvss_score != null ? vuln.cvss_score.toFixed(1) : '--'}
                    </td>
                    <td className="py-2 px-2">
                      <select
                        value={vuln.status}
                        onChange={(e) => handleStatusChange(vuln.id, e.target.value)}
                        disabled={updatingId === vuln.id}
                        className="text-xs border border-gray-300 dark:border-gray-600 rounded px-1.5 py-0.5 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 disabled:opacity-50"
                        aria-label={`Change status for ${vuln.cve_id}`}
                      >
                        {Object.entries(STATUS_LABELS).map(([value, label]) => (
                          <option key={value} value={value}>{label}</option>
                        ))}
                      </select>
                    </td>
                    <td className="py-2 px-2">
                      <button
                        onClick={() => handleDelete(vuln.id)}
                        className="text-red-400 hover:text-red-600 dark:text-red-500 dark:hover:text-red-400 text-xs"
                        title="Delete vulnerability"
                        aria-label={`Delete ${vuln.cve_id}`}
                      >
                        &#10005;
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
});

VulnerabilityPanel.displayName = 'VulnerabilityPanel';

export default VulnerabilityPanel;
